
// Global state management variables - Priority #3
var auraEnabled = false;
var isAwake = false;
var inConversation = false;

print("ğŸ¯ PRIORITY #3: INTELLIGENT STATE MANAGEMENT");
print("============================================");
print("ğŸ§  Smart conditional processing with state flags");
print("ğŸ¤ Voice-activated autonomous behavior control");
print("ğŸ¤– Animal personality with intelligent state transitions");
print("");

// State management functions with local state handling
function processVoiceCommand(audioText, currentAuraEnabled, currentAwake, currentInConversation)
{
    print("ğŸ¤ PROCESSING: \"" + audioText + "\"");
    
    // Check current state
    print("ğŸ“Š CURRENT STATE:");
    print("   ğŸ¯ Aura: " + currentAuraEnabled + " | ğŸ˜´ Awake: " + currentAwake + " | ğŸ’¬ In Conversation: " + currentInConversation);
    
    // ALWAYS process voice commands (Priority #1: Always-On Audio)
    if (audioText.includes("aura on"))
    {
        print("âœ… VOICE COMMAND: Aura activation detected");
        speakBeepBoop("ANIMAL AWAKE! AURA READY! BEEP-BOOP!", true);
        print("ğŸ§  STATE TRANSITION: DISABLED â†’ FULLY ACTIVE");
        return { aura: true, awake: true, conversation: true, action: "ACTIVATED" };
    }
    
    if (audioText.includes("aura off"))
    {
        print("âŒ VOICE COMMAND: Aura deactivation detected");
        speakBeepBoop("ANIMAL SLEEP... AURA OFF... zzz...", false);
        print("ğŸ§  STATE TRANSITION: ACTIVE â†’ DISABLED");
        return { aura: false, awake: false, conversation: false, action: "DEACTIVATED" };
    }
    
    if (audioText.includes("wake up"))
    {
        if (currentAuraEnabled)
        {
            print("ğŸ˜´ VOICE COMMAND: Wake up detected (Aura enabled)");
            speakBeepBoop("ANIMAL WAKE UP! READY FOR TALK!", false);
            print("ğŸ§  STATE TRANSITION: STANDBY â†’ LISTENING");
            return { aura: currentAuraEnabled, awake: true, conversation: true, action: "AWAKENED" };
        }
        else
        {
            print("ğŸ˜´ IGNORED: Wake up command (Aura disabled - say 'aura on' first)");
            return { aura: currentAuraEnabled, awake: currentAwake, conversation: currentInConversation, action: "IGNORED_DISABLED" };
        }
    }
    
    if (audioText.includes("go to sleep"))
    {
        if (currentAuraEnabled)
        {
            print("ï¿½ VOICE COMMAND: Sleep detected (Aura enabled)");
            speakBeepBoop("ANIMAL GO SLEEP... QUIET TIME... zzz...", false);
            print("ğŸ§  STATE TRANSITION: ACTIVE â†’ STANDBY");
            return { aura: currentAuraEnabled, awake: false, conversation: false, action: "SLEEPING" };
        }
        else
        {
            print("ğŸ˜´ IGNORED: Sleep command (Aura disabled)");
            return { aura: currentAuraEnabled, awake: currentAwake, conversation: currentInConversation, action: "IGNORED_DISABLED" };
        }
    }
    
    // Priority #3: STATE-DEPENDENT CONVERSATION PROCESSING
    if (currentAuraEnabled && currentAwake && currentInConversation)
    {
        print("ğŸ¤– INTELLIGENT PROCESSING: Full conversation mode");
        var response = generateAnimalResponse(audioText);
        speakBeepBoop(response, false);
        return { aura: currentAuraEnabled, awake: currentAwake, conversation: currentInConversation, action: "CONVERSING" };
    }
    else if (currentAuraEnabled && currentAwake)
    {
        print("ğŸ¤– LISTENING MODE: Ready but waiting for conversation");
        speakBeepBoop("ANIMAL HEAR YOU! TALK MORE!", false);
        return { aura: currentAuraEnabled, awake: currentAwake, conversation: true, action: "LISTENING" };
    }
    else if (currentAuraEnabled)
    {
        print("ï¿½ STANDBY MODE: Enabled but sleeping");
        print("ğŸ’¡ HINT: Say 'wake up' to activate conversation");
        return { aura: currentAuraEnabled, awake: currentAwake, conversation: currentInConversation, action: "STANDBY" };
    }
    else
    {
        print("âŒ DISABLED MODE: No processing");
        print("ğŸ’¡ HINT: Say 'aura on' to enable system");
        return { aura: currentAuraEnabled, awake: currentAwake, conversation: currentInConversation, action: "DISABLED" };
    }
}

// Animal personality with intelligent state management
function speakBeepBoop(message, isActivation)
{
    if (isActivation)
    {
        var activationSound = "[Wild Animal voice] BEEP-BOOP! " + message + " BEEP-BOOP!";
        tts.SpeakAsync(activationSound);
        print("ğŸ¥ ANIMAL (EXCITED): " + activationSound);
    }
    else
    {
        var responseSound = "[Animal voice] BEEP-BOOP! " + message + " BEEP-BOOP!";
        tts.SpeakAsync(responseSound);
        print("ğŸ¥ ANIMAL: " + responseSound);
    }
}

function generateAnimalResponse(userInput)
{
    var prompt = "Respond as Animal from Muppets - wild, enthusiastic, broken English, drum references, short phrases. To: '" + userInput + "'";
    return textGen.GenerateAsync(prompt, {
        temperature: 0.9,
        maxTokens: 50
    });
}

function updateSystemState(newAuraState, newAwakeState, newConversationState)
{
    auraEnabled = newAuraState;
    isAwake = newAwakeState;
    inConversation = newConversationState;
    
    print("ğŸ§  STATE UPDATE:");
    print("   ğŸ¯ Aura Enabled: " + auraEnabled);
    print("   ğŸ˜´ Is Awake: " + isAwake);
    print("   ğŸ’¬ In Conversation: " + inConversation);
}

function checkSystemState()
{
    print("ğŸ“Š CURRENT SYSTEM STATE:");
    print("   ğŸ¯ Aura Enabled: " + auraEnabled);
    print("   ğŸ˜´ Is Awake: " + isAwake);
    print("   ğŸ’¬ In Conversation: " + inConversation);
    
    if (auraEnabled && isAwake && inConversation)
    {
        print("   âœ… FULLY ACTIVE - All systems operational");
        return "FULLY_ACTIVE";
    }
    else if (auraEnabled && isAwake)
    {
        print("   ğŸŸ¡ LISTENING - Ready for conversation");
        return "LISTENING";
    }
    else if (auraEnabled)
    {
        print("   ğŸ”µ STANDBY - Aura enabled but sleeping");
        return "STANDBY";
    }
    else
    {
        print("   âŒ DISABLED - System offline");
        return "DISABLED";
    }
}

// Intelligent state-dependent audio processing
function processAudioInput(audioText)
{
    print("ğŸ¤ HEARD: \"" + audioText + "\"");
    
    // ALWAYS process voice commands (Priority #1: Always-On Audio)
    if (audioText.includes("aura on"))
    {
        // Priority #3: Intelligent State Management - Activation sequence
        updateSystemState(true, true, true);
        speakBeepBoop("ANIMAL AWAKE! AURA READY! ME LISTEN NOW!", true);
        print("âœ… SYSTEM ACTIVATED - Full conversational mode");
        return;
    }
    
    if (audioText.includes("aura off"))
    {
        // Priority #3: Intelligent State Management - Deactivation sequence
        updateSystemState(false, false, false);
        speakBeepBoop("ANIMAL SLEEP NOW... AURA OFF... DRUMS QUIET...", false);
        print("âŒ SYSTEM DEACTIVATED - All processing stopped");
        return;
    }
    
    if (audioText.includes("wake up"))
    {
        if (auraEnabled)
        {
            // Priority #3: State-dependent processing - Only if Aura enabled
            updateSystemState(auraEnabled, true, true);
            speakBeepBoop("ANIMAL WAKE UP! READY FOR TALK!", false);
        }
        else
        {
            print("ğŸ˜´ IGNORED - Aura system disabled (say 'aura on' first)");
        }
        return;
    }
    
    if (audioText.includes("go to sleep"))
    {
        if (auraEnabled)
        {
            // Priority #3: Intelligent conditional processing
            updateSystemState(auraEnabled, false, false);
            speakBeepBoop("ANIMAL GO SLEEP... ZZZ... BEEP-BOOP...", false);
        }
        else
        {
            print("ğŸ˜´ IGNORED - Aura system disabled");
        }
        return;
    }
    
    // Priority #3: STATE-DEPENDENT CONVERSATION PROCESSING
    if (auraEnabled && isAwake && inConversation)
    {
        print("ğŸ¤– PROCESSING CONVERSATION (All systems active)");
        var response = generateAnimalResponse(audioText);
        speakBeepBoop(response, false);
    }
    else if (auraEnabled && isAwake)
    {
        print("ğŸ¤– LISTENING MODE (Ready but not in conversation)");
        speakBeepBoop("ANIMAL HEAR YOU! TALK MORE!", false);
        updateSystemState(auraEnabled, isAwake, true);
    }
    else if (auraEnabled)
    {
        print("ğŸ˜´ STANDBY MODE (Enabled but sleeping)");
        print("ğŸ’¡ HINT: Say 'wake up' to activate conversation");
    }
    else
    {
        print("âŒ DISABLED MODE - No processing");
        print("ğŸ’¡ HINT: Say 'aura on' to enable system");
    }
}

try
{
    print("ğŸš€ PHASE 1: Initialize Always-On Audio");
    print("======================================");
    
    // Start microphone services
    print("ğŸ¤ Starting microphone capture...");
    micCapture.StartListeningAsync();
    print("âœ… Microphone listening started");
    
    print("ğŸ”„ Starting live audio transcription...");
    liveAudio.StartAsync();
    print("âœ… Live audio processing started");
    
    print("");
    print("ğŸ¯ PHASE 2: INTELLIGENT STATE MANAGEMENT TESTING");
    print("===============================================");
    
    // Test initial state
    print("ğŸ“Š TESTING INITIAL STATE:");
    checkSystemState();
    print("");
    
    // Test state transitions
    print("ğŸ”Š TESTING STATE TRANSITIONS:");
    print("-------------------------------");
    
    print("1ï¸âƒ£ Testing Aura activation...");
    processAudioInput("aura on");
    checkSystemState();
    print("");
    
    print("2ï¸âƒ£ Testing conversation while active...");
    processAudioInput("hello animal how are you doing today");
    print("");
    
    print("3ï¸âƒ£ Testing sleep command...");
    processAudioInput("go to sleep");
    checkSystemState();
    print("");
    
    print("4ï¸âƒ£ Testing ignored input while sleeping...");
    processAudioInput("can you hear me now");
    print("");
    
    print("5ï¸âƒ£ Testing wake up command...");
    processAudioInput("wake up");
    checkSystemState();
    print("");
    
    print("6ï¸âƒ£ Testing conversation after wake up...");
    processAudioInput("tell me about drums");
    print("");
    
    print("7ï¸âƒ£ Testing full deactivation...");
    processAudioInput("aura off");
    checkSystemState();
    print("");
    
    print("8ï¸âƒ£ Testing completely ignored input when disabled...");
    processAudioInput("hello are you there");
    print("");
    
    print("ğŸ† INTELLIGENT STATE MANAGEMENT - SUCCESS!");
    print("==========================================");
    print("âœ… Global State Flags: auraEnabled, isAwake, inConversation working");
    print("âœ… Smart Conditional Processing: State-dependent behavior operational");
    print("âœ… Voice Command Control: 'aura on/off', 'wake up', 'go to sleep'");
    print("âœ… Intelligent Early Returns: Proper processing flow control");
    print("âœ… State Transitions: Smooth activation/deactivation sequences");
    
    print("");
    print("ğŸ¯ PRIORITY #3 COMPLETE - INTELLIGENT STATE MANAGEMENT READY!");
}
catch (error)
{
    print("âŒ Error in intelligent state management: " + error);
}

print("");
print("ğŸ”‡ GRACEFUL SHUTDOWN");
print("====================");

liveAudio.StopAsync();
print("âœ… Live audio stopped");

micCapture.StopListeningAsync();
print("âœ… Microphone stopped");

print("");
print("ğŸ¯ INTELLIGENT STATE MANAGEMENT SESSION COMPLETE!");
print("ğŸ§  Smart conditional processing with global state control operational!");
