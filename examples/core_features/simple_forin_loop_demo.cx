// Simple PowerShell Output for...in Loop Demo  
// Demonstrates clear iteration over PowerShell array results
// INSTRUMENTED: Added vector database search to inspect agent memory

print("ğŸ”„ Simple PowerShell Array Iteration Demo\n");

// Add learning detection events
on ai.learning.complete (payload) 
{
    print("âœ… LEARNING SUCCESS DETECTED:");
    print("   Agent: " + payload.agent);
    print("   Document ID: " + payload.documentId);
    print("   Status: " + payload.status);
    print("   Content Length: " + payload.contentLength);
    print("   Knowledge: " + payload.knowledge);
    print("");
    
    // AUTO-TRIGGER SEARCH: Test if content is now searchable after learning
    print("ğŸ” AUTO-SEARCH: Testing if learned content is now searchable...");
    
    // Try to search for content we just learned based on common keywords
    if (payload.agent == "SimpleIterator") 
    {
        // Search for different aspects of what might have been learned
        print("   â†’ Auto-searching for: SimpleIterator");
        // Note: Can't call methods in event handlers, but we can emit search events
        emit search.trigger, { 
            agent: payload.agent, 
            query: "SimpleIterator", 
            reason: "auto_search_after_learning",
            documentId: payload.documentId 
        };
        
        print("   â†’ Auto-searching for: PowerShell array");
        emit search.trigger, { 
            agent: payload.agent, 
            query: "PowerShell array", 
            reason: "auto_search_after_learning",
            documentId: payload.documentId 
        };
        
        print("   â†’ Auto-searching for: for-in loop");
        emit search.trigger, { 
            agent: payload.agent, 
            query: "for-in loop", 
            reason: "auto_search_after_learning",
            documentId: payload.documentId 
        };
    }
}

on ai.learning.failed (payload) 
{
    print("âŒ LEARNING FAILED:");
    print("   Agent: " + payload.agent);
    print("   Reason: " + payload.reason);
    print("");
}

// Add search result detection events
on ai.search.complete (payload) 
{
    print("ğŸ” VECTOR DATABASE SEARCH RESULTS:");
    print("   Agent: " + payload.agent);
    print("   Query: " + payload.query);
    print("   Results Found: " + payload.resultsCount);
    print("   Processing Time: " + payload.processingTimeMs + "ms");
    
    if (payload.resultsCount > 0) 
    {
        print("   ğŸ“š Top Result Content: " + payload.topResult);
        print("   ğŸ“Š All Results:");
        
        // Iterate through search results if available
        if (payload.results && payload.results.length > 0) 
        {
            for (var result in payload.results) 
            {
                print("      â†’ Score: " + result.score);
                print("      â†’ Content: " + result.content);
                print("      â”€â”€â”€â”€â”€â”€â”€â”€â”€");
            }
        }
    } 
    else 
    {
        print("   âŒ No matching content found in vector database");
    }
    print("");
}

on ai.search.failed (payload) 
{
    print("âŒ VECTOR DATABASE SEARCH FAILED:");
    print("   Agent: " + payload.agent);
    print("   Reason: " + payload.reason);
    print("");
}

// Global variable to store the iterator for auto-searches
var globalIterator = null;

// Handler for auto-triggered searches after learning
on search.trigger (payload) 
{
    print("ğŸ¯ SEARCH TRIGGER: Auto-search initiated");
    print("   Query: " + payload.query);
    print("   Reason: " + payload.reason);
    print("   Document: " + payload.documentId);
    
    // Use the global iterator to perform the search
    if (globalIterator != null) 
    {
        globalIterator.performAutoSearch(payload.query);
    }
    else
    {
        print("   âŒ Global iterator not available for auto-search");
    }
    
    print("");
}

on command.executed (payload) 
{
    print("ğŸ“‹ Processing Command Results:");
    print("   Command: " + payload.command);
    print("   Success: " + payload.success);
    
    // Get output count
    var outputCount = payload.outputs.length;
    print("   Output Count: " + outputCount);
    print("");
    
    if (outputCount > 0) 
    {
        print("ğŸ” Iterating through each output item with for...in:");
        
        // CX for...in loop - the key demonstration!
        for (var item in payload.outputs) 
        {
            print("   â†’ Item: " + item);
            print("   â†’ Type: " + typeof(item));
            
            // Show item processing
            if (typeof(item) == "string") 
            {
                print("   â†’ String Length: " + item.length);
                
                if (item.indexOf("Item") > -1) 
                {
                    print("   â†’ âœ… Contains 'Item' text");
                }
            }
            print("   â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        }
        
        print("âœ… for...in iteration complete!");
    } 
    else 
    {
        print("â„¹ï¸ No output items to iterate");
    }
    
    print("");
}

class SimpleIterator 
{
    name: string;
    
    constructor(agentName: string) 
    {
        this.name = agentName;
        print("ğŸ¤– Simple Iterator " + agentName + " ready");
    }
    
    function testSimpleArray() 
    {
        print("ğŸ“¦ Testing simple PowerShell array:");
        
        // Learn about what we're about to do
        this.Learn({
            action: "PowerShell array test",
            command: "@('Item1', 'Item2', 'Item3', 'Item4', 'Item5') | ForEach-Object { Write-Output $_ }",
            purpose: "Testing for-in loop iteration over PowerShell array results",
            agent: this.name,
            timestamp: "2025-07-22"
        });
        
        // First, search the vector database to see what's stored
        print("ğŸ” Searching vector database for existing content...");
        this.Search("PowerShell array iteration for loop");
        
        // Create a simple PowerShell array that will produce clear output
        var command = "@('Item1', 'Item2', 'Item3', 'Item4', 'Item5') | ForEach-Object { Write-Output $_ }";
        print("   Executing: " + command);
        this.Execute(command);
        
        print("   âœ… Command dispatched - watch for for...in iteration results");
    }
    
    function testStringArray() 
    {
        print("ğŸ“ Testing string output array:");
        
        // Learn about the string test
        this.Learn({
            action: "String array test", 
            command: "Write-Output 'First'; Write-Output 'Second'; Write-Output 'Third'",
            purpose: "Testing for-in loop with string outputs",
            agent: this.name,
            timestamp: "2025-07-22"
        });
        
        // Search for string-related content
        print("ğŸ” Searching vector database for string content...");
        this.Search("string array output PowerShell command");
        
        // Simple string outputs
        var command = "Write-Output 'First'; Write-Output 'Second'; Write-Output 'Third'";
        print("   Executing: " + command);
        this.Execute(command);
        
        print("   âœ… String array command dispatched");
    }
    
    function searchAgentMemory() 
    {
        print("ğŸ§  " + this.name + ": Comprehensive vector database search:");
        
        // Search for content that should match what we learned
        print("   â†’ Searching for: SimpleIterator agent");
        this.Search("SimpleIterator agent PowerShell iteration");
        
        print("   â†’ Searching for: for-in loop syntax");  
        this.Search("CX Language for-in loops arrays collections");
        
        print("   â†’ Searching for: PowerShell integration");
        this.Search("PowerShell Command Execution fire-and-forget");
        
        print("   â†’ Searching for: array test actions");
        this.Search("PowerShell array test command execution");
        
        print("   â†’ Searching for: string test actions");
        this.Search("String array test Write-Output commands");
        
        print("   âœ… All search queries dispatched - monitor search results");
    }
    
    function learnFromExperience() 
    {
        print("ğŸ“š " + this.name + ": Learning fundamental concepts...");
        
        // Learn some basic facts about this agent
        this.Learn({
            agentType: "SimpleIterator",
            purpose: "Demonstrate PowerShell array iteration with for-in loops",
            capabilities: ["PowerShell execution", "Array iteration", "Vector database operations"],
            specialization: "for-in loop processing and command result analysis",
            timestamp: "2025-07-22"
        });
        
        // Learn about CX language features being demonstrated
        this.Learn({
            topic: "CX Language for-in Loops",
            description: "CX supports for-in loop syntax for iterating over arrays and collections",
            syntax: "for (var item in collection) { ... }",
            use_case: "PowerShell command result processing",
            demonstration: "Iterating through PowerShell array outputs",
            agent: this.name
        });
        
        // Learn about PowerShell integration
        this.Learn({
            integration: "PowerShell Command Execution",
            method: "this.Execute() for fire-and-forget PowerShell commands",
            event_system: "command.executed events with output arrays",
            processing: "CX for-in loops iterate through PowerShell results",
            agent: this.name,
            context: "CX-PowerShell integration demonstration"
        });
        
        print("   âœ… Learning operations dispatched - knowledge stored in vector database");
    }
    
    function performAutoSearch(query: string)
    {
        print("ğŸ” " + this.name + ": Performing auto-triggered search...");
        print("   Query: " + query);
        this.Search(query);
        print("   âœ… Auto-search dispatched");
    }
}

// Create iterator and test
var iterator = new SimpleIterator("ForInLoop-Agent");
globalIterator = iterator;  // Set global reference for auto-search

print("ğŸ“š Step 1: Learning Fundamental Concepts");
iterator.learnFromExperience();

print("\nğŸ§  Step 2: Searching Vector Database (should be empty initially)");
iterator.searchAgentMemory();

print("\nğŸ¯ Step 3: Execute Commands & Learn from Results");
iterator.testSimpleArray();

print("\nğŸ¯ Step 4: More Commands & Learning");
iterator.testStringArray();

print("\nğŸ” Step 5: Final Search (should find learned content)");
iterator.searchAgentMemory();

print("\nğŸ”‘ Press any key to continue or watch the learning â†’ searching cycle in action...\n");
