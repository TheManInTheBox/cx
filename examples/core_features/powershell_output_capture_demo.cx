// ğŸ’¾ POWERSHELL OUTPUT CAPTURE & ROUTING DEMONSTRATION  
// Shows how PowerShell stdout/stderr is captured and routed through event payloads for agent learning

print("ğŸ¬ PowerShell Output Capture & Learning Demo Starting...\n");

// Global event handler to monitor all command executions
on command.executed (payload) 
{
    print("ğŸ” GLOBAL MONITOR: Command execution detected");
    print("   ğŸ¤– Agent: " + payload.agent);
    print("   âš¡ Command: " + payload.command);
    print("   âœ… Success: " + payload.success);
    print("   ğŸšª Exit Code: " + payload.exitCode);
    print("   ğŸ“… Time: " + payload.executionTime);
    
    // Display captured PowerShell stdout
    if (payload.outputs && payload.outputs.length > 0) 
    {
        print("   ğŸ“¤ STDOUT Captured (" + payload.outputs.length + " items):");
        var maxDisplay = 3;
        if (payload.outputs.length > maxDisplay) 
        {
            print("     Showing first " + maxDisplay + " of " + payload.outputs.length + " stdout items");
        }
    }
    
    // Display captured PowerShell stderr
    if (payload.errors && payload.errors.length > 0) 
    {
        print("   ğŸ“¥ STDERR Captured (" + payload.errors.length + " items):");
        var maxDisplay = 3;
        if (payload.errors.length > maxDisplay) 
        {
            print("     Showing first " + maxDisplay + " of " + payload.errors.length + " error items");
        }
    }
    
    print("   ---");
}

// Agent that executes various PowerShell commands and learns from outputs
class PowerShellAgent 
{
    name: string;
    executionCount: number;
    
    constructor(agentName) 
    {
        this.name = agentName;
        this.executionCount = 0;
        print("ğŸ¤– PowerShell Agent " + agentName + " initialized for output capture testing");
    }
    
    // Execute command with successful output
    function executeSuccessCommand() 
    {
        this.executionCount = this.executionCount + 1;
        print("\nğŸŸ¢ " + this.name + ": Executing command #" + this.executionCount + " (Success Expected)");
        
        // Command that will produce stdout
        this.Execute("Get-Date | Select-Object -Property DateTime, DayOfWeek");
        
        print("   â³ Command dispatched - awaiting output capture...");
    }
    
    // Execute command with error output  
    function executeErrorCommand() 
    {
        this.executionCount = this.executionCount + 1;
        print("\nğŸ”´ " + this.name + ": Executing command #" + this.executionCount + " (Error Expected)");
        
        // Command that will produce stderr
        this.Execute("Get-NonExistentCommand -InvalidParameter");
        
        print("   â³ Error command dispatched - awaiting stderr capture...");
    }
    
    // Execute command with mixed output
    function executeMixedCommand() 
    {
        this.executionCount = this.executionCount + 1;
        print("\nğŸŸ¡ " + this.name + ": Executing command #" + this.executionCount + " (Mixed Output Expected)");
        
        // Command with both stdout and potential warnings
        this.Execute("Get-Process | Where-Object { $_.ProcessName -like 'notepad*' } | Select-Object -First 5");
        
        print("   â³ Mixed command dispatched - awaiting output capture...");
    }
    
    // Event handler to process captured PowerShell output
    on command.executed (payload) 
    {
        // Filter to only this agent's commands
        if (payload.agent != this.name) return;
        
        print("\nğŸ¯ " + this.name + ": Processing captured PowerShell output");
        
        // Analyze and learn from stdout
        if (payload.outputs && payload.outputs.length > 0) 
        {
            print("   ğŸ§  Learning from " + payload.outputs.length + " stdout items");
            
            // Learn from overall stdout pattern - fire-and-forget
            this.Learn({
                source: "powershell_stdout",
                command: payload.command,
                output_count: payload.outputs.length,
                execution_time: payload.executionTime,
                agent: this.name,
                learning_context: "stdout_analysis"
            });
            
            print("     ğŸ“ Learned from stdout pattern with " + payload.outputs.length + " items");
        }
        
        // Analyze and learn from stderr
        if (payload.errors && payload.errors.length > 0) 
        {
            print("   ğŸš¨ Learning from " + payload.errors.length + " stderr items");
            
            // Learn from overall stderr pattern - fire-and-forget
            this.Learn({
                source: "powershell_stderr",
                command: payload.command,
                error_count: payload.errors.length,
                execution_time: payload.executionTime,
                agent: this.name,
                learning_context: "stderr_analysis"
            });
            
            print("     ğŸ” Learned from error pattern with " + payload.errors.length + " items");
        }
        
        // Generate insights from captured outputs - fire-and-forget
        if (payload.success) 
        {
            this.Think("Analyze the PowerShell command output patterns and extract system insights from: " + payload.command);
        } 
        else 
        {
            this.Think("Analyze PowerShell error patterns and suggest remediation strategies for: " + payload.command);
        }
        
        print("   âœ… Output processing and learning completed");
    }
    
    // Reveal learned knowledge about PowerShell executions
    function revealLearnings() 
    {
        print("\nğŸ”® " + this.name + ": Revealing learned knowledge from PowerShell executions");
        
        // Search for learned PowerShell knowledge - fire-and-forget
        this.Search("powershell stdout stderr output learning execution commands");
        
        // Share insights about captured outputs
        emit agent.revelation, {
            agent: this.name,
            knowledge: "Captured and analyzed PowerShell stdout/stderr from " + this.executionCount + " command executions",
            learning_sources: ["powershell_stdout", "powershell_stderr"],
            insight_areas: ["command_patterns", "error_analysis", "output_types", "execution_timing"]
        };
    }
}

// Create the demonstration agent
var psAgent = new PowerShellAgent("OutputCapture-Agent");

print("\nğŸš€ DEMONSTRATION SEQUENCE:\n");

// Execute commands with different output patterns
print("Phase 1: Successful command execution");
psAgent.executeSuccessCommand();

print("\nâ³ Brief pause for first command processing...");

print("\nPhase 2: Error command execution"); 
psAgent.executeErrorCommand();

print("\nâ³ Brief pause for error processing...");

print("\nPhase 3: Mixed output command execution");
psAgent.executeMixedCommand();

print("\nâ³ Brief pause for mixed command processing...");

print("\nPhase 4: Knowledge revelation");
psAgent.revealLearnings();

print("\nğŸ“‹ POWERSHELL OUTPUT CAPTURE CAPABILITIES:");
print("âœ… Complete stdout capture with value and type");
print("âœ… Complete stderr capture with message, category, and line numbers");
print("âœ… Success/failure status routing");
print("âœ… Command and agent identification");
print("âœ… Execution timestamp tracking");
print("âœ… Event-driven learning integration");
print("âœ… Fire-and-forget AI processing");
print("âœ… Agent-specific output filtering");
print("âœ… Comprehensive error analysis");
print("âœ… Mixed output handling");

print("\nğŸ¯ LEARNING INTEGRATION:");
print("ğŸ§  Agents learn from captured PowerShell outputs");
print("ğŸ” Both stdout and stderr feed into agent memory");
print("ğŸ’¡ AI thinking processes command results");
print("ğŸ“Š Output patterns analyzed for insights");
print("ğŸš¨ Error patterns analyzed for remediation");
print("ğŸ”„ Complete fire-and-forget learning cycle");

print("\nğŸ“– OUTPUT PAYLOAD STRUCTURE:");
print("ğŸ“¤ payload.outputs[] - Array of stdout items with .value and .type");
print("ğŸ“¥ payload.errors[] - Array of stderr items with .message, .category, .line");
print("âœ… payload.success - Boolean success/failure status");
print("âš¡ payload.command - Original executed command");
print("ğŸšª payload.exitCode - Command exit code");
print("ğŸ¤– payload.agent - Agent that executed the command");
print("ğŸ“… payload.executionTime - Execution timestamp");

print("\nğŸ¬ Demo complete! PowerShell output is captured and routed through event payloads for agent learning. âœ¨");
