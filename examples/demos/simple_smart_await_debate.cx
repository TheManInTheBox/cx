// SIMPLIFIED SMART AWAIT DEBATE DEMO
// Two AI agents debating with turn-based order and optimized timing
// Features: Smart await coordination, slowed speech (-10%), real-time audio

print("ğŸ­ Smart Await Debate Demo - Simplified");
print("Turn-Based AI Agent Debate System");
print("=================================");

class SimpleDebateAgent
{
    name: string;
    position: string;
    turnNumber: number = 0;
    speechSpeed: number = 0.9; // 10% slower speech
    
    constructor(agentName: string, debatePosition: string)
    {
        this.name = agentName;
        this.position = debatePosition;
        print("ğŸ¯ " + this.name + " created - Position: " + this.position);
        print("  Speech speed: " + this.speechSpeed + " (10% slower)");
    }
    
    function startTurn(turnNum: number)
    {
        this.turnNumber = turnNum;
        print("ğŸ¤ " + this.name + " starting turn " + turnNum);
        
        // âœ… SMART AWAIT: Optimal preparation timing before speaking
        await { 
            reason: "debate_preparation_" + this.name + "_turn_" + turnNum,
            context: "Agent " + this.name + " preparing argument for turn " + turnNum,
            minDurationMs: 1000,
            maxDurationMs: 2500,
            handlers: [ preparation.complete ]
        };
    }
    
    function makeArgument()
    {
        print("ğŸ’¬ " + this.name + " (" + this.position + ") making argument:");
        
        var argumentText = "As the " + this.position + " advocate, I believe this perspective is crucial for our discussion.";
        print("  Argument: " + argumentText);
        
        // âœ… SMART AWAIT: Timing before speech synthesis
        await { 
            reason: "speech_preparation_" + this.name,
            context: "Preparing speech synthesis for " + this.name + " with " + this.speechSpeed + " speed",
            minDurationMs: 500,
            maxDurationMs: 1500,
            handlers: [ speech.ready ]
        };
    }
    
    function synthesizeSpeech(text: string)
    {
        print("ğŸ¤ " + this.name + " synthesizing speech (speed: " + this.speechSpeed + ")");
        
        // Connect to Azure Realtime API for speech
        emit realtime.connect { 
            demo: "debate_" + this.name.toLowerCase(),
            agent: this.name,
            speechSpeed: this.speechSpeed
        };
    }
    
    function finishTurn()
    {
        print("âœ… " + this.name + " turn " + this.turnNumber + " complete");
        
        // âœ… SMART AWAIT: Post-turn pause for natural flow
        await { 
            reason: "post_turn_pause_" + this.name,
            context: "Natural pause after " + this.name + " completes turn",
            minDurationMs: 1000,
            maxDurationMs: 2000,
            handlers: [ turn.complete ]
        };
    }
    
    // âœ… SMART AWAIT: Preparation completion handler
    on preparation.complete (event)
    {
        if (event.reason.indexOf(this.name) >= 0)
        {
            print("ğŸ§  " + this.name + " preparation complete (" + event.actualDurationMs + "ms)");
            this.makeArgument();
        }
    }
    
    // âœ… SPEECH READY: Speech synthesis ready handler
    on speech.ready (event)
    {
        if (event.reason.indexOf(this.name) >= 0)
        {
            print("ğŸ™ï¸ " + this.name + " speech ready (" + event.actualDurationMs + "ms)");
            var argumentText = "This is my " + this.position + " argument for the debate.";
            this.synthesizeSpeech(argumentText);
        }
    }
    
    // âœ… AZURE REALTIME: Connection handler
    on realtime.connected (event)
    {
        if (event.agent == this.name)
        {
            print("ğŸ”— " + this.name + " connected to Azure Realtime API");
            
            emit realtime.session.create { 
                deployment: "gpt-4o-mini-realtime-preview",
                mode: "voice",
                voice: "alloy",
                agent: this.name,
                speechSpeed: this.speechSpeed
            };
        }
    }
    
    // âœ… SESSION CREATED: Start speaking
    on realtime.session.created (event)
    {
        if (event.agent == this.name)
        {
            print("ğŸ™ï¸ " + this.name + " voice session ready - speaking argument");
            
            var debateText = "Hello, I am " + this.name + " representing the " + this.position + " position in this debate.";
            
            emit realtime.text.send { 
                text: debateText,
                deployment: "gpt-4o-mini-realtime-preview",
                voice: "alloy",
                speed: this.speechSpeed,
                agent: this.name
            };
        }
    }
    
    // âœ… AUDIO RESPONSE: Handle speech with slowed speed
    on realtime.audio.response (event)
    {
        if (event.agent == this.name)
        {
            print("ğŸ”Š " + this.name + " audio response (speed: " + this.speechSpeed + ")");
            
            if (event.audioData != null)
            {
                emit audio.stream.direct { 
                    audioData: event.audioData,
                    format: "pcm16_24khz",
                    autoPlay: true,
                    source: "debate_" + this.name,
                    speechSpeed: this.speechSpeed,
                    agent: this.name
                };
            }
            
            if (event.isComplete)
            {
                print("âœ… " + this.name + " speech complete");
                this.finishTurn();
            }
        }
    }
    
    // âœ… TURN COMPLETION: Handle turn completion
    on turn.complete (event)
    {
        if (event.reason.indexOf(this.name) >= 0)
        {
            print("ğŸ‰ " + this.name + " turn sequence complete (" + event.actualDurationMs + "ms pause)");
            
            emit agent.turn.finished { 
                agent: this.name,
                turnNumber: this.turnNumber,
                position: this.position
            };
        }
    }
}

// âœ… GLOBAL SMART AWAIT HANDLERS
on await.smart.complete (event)
{
    print("ğŸ§  Smart await optimization complete:");
    print("  Reason: " + event.reason);
    print("  Duration: " + event.actualDurationMs + "ms");
    print("  Context: " + event.context);
}

on await.completed (event)
{
    print("â° Await completed:");
    print("  Duration: " + event.actualDurationMs + "ms");
    print("  Success: " + event.success);
}

// âœ… AUDIO STREAMING HANDLERS
on audio.stream.direct (event)
{
    if (event.agent)
    {
        print("ğŸ”Š Audio streaming for " + event.agent + " (speed: " + event.speechSpeed + ")");
    }
}

// âœ… TURN MANAGEMENT: Simple turn controller
var currentTurn = 1;
var maxTurns = 4;
var agent1 = null;
var agent2 = null;

function startDebate()
{
    print("ğŸš€ Starting simplified smart await debate...");
    print("ğŸ“ Topic: The role of AI in society");
    print("ğŸ”„ Max turns: " + maxTurns);
    print("");
    
    // Create agents with slowed speech
    agent1 = new SimpleDebateAgent("Alice", "Pro-AI");
    agent2 = new SimpleDebateAgent("Bob", "Cautious-AI");
    
    // âœ… SMART AWAIT: Debate initialization timing
    await { 
        reason: "debate_initialization",
        context: "Optimizing timing for debate startup between Alice and Bob",
        minDurationMs: 2000,
        maxDurationMs: 3000,
        handlers: [ debate.start ]
    };
}

function nextTurn()
{
    if (currentTurn > maxTurns)
    {
        endDebate();
        return;
    }
    
    print("");
    print("ğŸ¯ === TURN " + currentTurn + " ===");
    
    // Alternate between agents
    if (currentTurn % 2 == 1)
    {
        print("ğŸ¤ Alice's turn");
        agent1.startTurn(currentTurn);
    }
    else
    {
        print("ğŸ¤ Bob's turn");
        agent2.startTurn(currentTurn);
    }
}

function endDebate()
{
    print("");
    print("ğŸ SMART AWAIT DEBATE COMPLETE!");
    print("ğŸ“Š Total turns: " + (currentTurn - 1));
    print("ğŸ­ Participants: Alice (Pro-AI) vs Bob (Cautious-AI)");
    print("âœ… Smart await timing optimization demonstrated successfully");
    
    emit debate.complete { 
        totalTurns: currentTurn - 1,
        agent1: "Alice",
        agent2: "Bob",
        topic: "The role of AI in society"
    };
}

// âœ… DEBATE FLOW HANDLERS
on debate.start (event)
{
    print("ğŸ¬ Debate initialization complete (" + event.actualDurationMs + "ms)");
    print("ğŸ¯ Starting Turn 1...");
    nextTurn();
}

on agent.turn.finished (event)
{
    print("âœ… Turn " + event.turnNumber + " finished by " + event.agent + " (" + event.position + ")");
    
    currentTurn = currentTurn + 1;
    
    // âœ… SMART AWAIT: Inter-turn pause for natural flow
    await { 
        reason: "inter_turn_pause",
        context: "Natural pause between debate turns for better flow",
        minDurationMs: 1500,
        maxDurationMs: 2500,
        handlers: [ inter.turn.ready ]
    };
}

on inter.turn.ready (event)
{
    print("â³ Inter-turn pause complete (" + event.actualDurationMs + "ms)");
    nextTurn();
}

on debate.complete (event)
{
    print("ğŸ† FINAL DEBATE RESULTS:");
    print("  Topic: " + event.topic);
    print("  Turns completed: " + event.totalTurns);
    print("  Participants: " + event.agent1 + " vs " + event.agent2);
    print("ğŸ­ Smart await debate demonstration successful!");
}

// ğŸš€ START THE SIMPLIFIED SMART AWAIT DEBATE
print("ğŸ­ SMART AWAIT DEBATE DEMO:");
print("âœ… Speech speed: 90% (10% slower)");
print("âœ… Turn-based coordination with smart await");
print("âœ… Real-time audio synthesis");
print("âœ… Optimized timing between all phases");
print("");

startDebate();

print("ğŸš€ Smart await debate system initialized!");
print("â° Watch for optimized timing coordination...");
