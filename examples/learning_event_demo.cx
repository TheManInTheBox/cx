// LEARNING DEMO: Event Payload Analysis
// Educational demonstration that prints all event payloads for learning
// Helps understand the CX Language event system and data flow

print("ğŸ“š CX Language Learning Demo - Event Payload Analysis");
print("Printing all event payloads to understand the system");
print("====================================================");

class LearningAgent
{
    name: string = "LearningAgent";
    eventCount: number = 0;
    
    function startLearning()
    {
        print("ğŸ“ Starting learning session...");
        print("Agent: " + this.name);
        
        // Start with Azure Realtime connection to see all events
        emit realtime.connect { demo: "learning_analysis" };
    }
    
    function analyzeEvent(eventName: string, payload: any)
    {
        this.eventCount = this.eventCount + 1;
        print("\nğŸ” === EVENT ANALYSIS #" + this.eventCount + " ===");
        print("ğŸ“‹ Event Name: " + eventName);
        print("ğŸ“¦ Payload Type: " + typeof(payload));
        print("ğŸ“„ Payload Content:");
        print(payload);  // This should auto-serialize to JSON
        print("ğŸ”š === END EVENT #" + this.eventCount + " ===");
    }
    
    // âœ… Learn from Azure Realtime events
    on realtime.connected (event)
    {
        this.analyzeEvent("realtime.connected", event);
        
        // Continue the learning by creating a session
        emit realtime.session.create { 
            deployment: "gpt-4o-mini-realtime-preview",
            mode: "voice"
        };
    }
    
    on realtime.session.created (event)
    {
        this.analyzeEvent("realtime.session.created", event);
        
        // Send a learning message
        emit realtime.text.send { 
            text: "Hello! I'm learning about the CX Language event system.",
            deployment: "gpt-4o-mini-realtime-preview"
        };
    }
    
    on realtime.text.response (event)
    {
        this.analyzeEvent("realtime.text.response", event);
        
        // Emit a custom learning event
        emit learning.text.analyzed { 
            agent: this.name,
            content: event.content,
            isComplete: event.isComplete,
            timestamp: "2025-07-23"
        };
    }
    
    on realtime.audio.response (event)
    {
        this.analyzeEvent("realtime.audio.response", event);
        
        // Try to play audio and analyze the playback events
        if (event.audioData != null)
        {
            print("ğŸµ Attempting audio playback for learning...");
            emit audio.stream.direct { 
                audioData: event.audioData,
                agent: this.name,
                format: "pcm16",
                sampleRate: 24000
            };
        }
        
        // Emit custom learning event
        emit learning.audio.analyzed { 
            agent: this.name,
            hasAudio: (event.audioData != null),
            isComplete: event.isComplete,
            dataType: typeof(event.audioData)
        };
    }
    
    on realtime.error (event)
    {
        this.analyzeEvent("realtime.error", event);
        
        // Continue learning with simulated data
        emit learning.fallback.ready { 
            agent: this.name,
            reason: "azure_config_needed"
        };
    }
    
    // âœ… Learn from custom events we emit
    on learning.text.analyzed (event)
    {
        this.analyzeEvent("learning.text.analyzed", event);
    }
    
    on learning.audio.analyzed (event)
    {
        this.analyzeEvent("learning.audio.analyzed", event);
    }
    
    on learning.fallback.ready (event)
    {
        this.analyzeEvent("learning.fallback.ready", event);
        
        print("ğŸ­ Simulating events for learning...");
        
        // Simulate a text response
        emit realtime.text.response {
            content: "This is a simulated response for learning purposes.",
            isComplete: true,
            source: "simulation"
        };
        
        // Simulate an audio response
        emit realtime.audio.response {
            audioData: "simulated_audio_bytes",
            isComplete: true,
            audioFormat: "pcm16",
            source: "simulation"
        };
    }
}

// âœ… Global learning event handlers - analyze ALL events

on naudio.playback.started (event)
{
    print("\nğŸµ === NAUDIO PLAYBACK STARTED EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END NAUDIO PLAYBACK STARTED ===");
}

on audio.streaming.complete (event)
{
    print("\nğŸ‰ === AUDIO STREAMING COMPLETE EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END AUDIO STREAMING COMPLETE ===");
}

on audio.streaming.error (event)
{
    print("\nâŒ === AUDIO STREAMING ERROR EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END AUDIO STREAMING ERROR ===");
}

on audio.stream.blocked (event)
{
    print("\nâš ï¸ === AUDIO STREAM BLOCKED EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END AUDIO STREAM BLOCKED ===");
}

// âœ… AI Service Learning Events
on ai.think.request (event)
{
    print("\nğŸ§  === AI THINK REQUEST EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END AI THINK REQUEST ===");
}

on thinking.complete (event)
{
    print("\nğŸ’¡ === THINKING COMPLETE EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END THINKING COMPLETE ===");
}

on ai.learn.request (event)
{
    print("\nğŸ“š === AI LEARN REQUEST EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END AI LEARN REQUEST ===");
}

on learning.complete (event)
{
    print("\nğŸ“ === LEARNING COMPLETE EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END LEARNING COMPLETE ===");
}

// âœ… System Events
on system.ready (event)
{
    print("\nâš¡ === SYSTEM READY EVENT ===");
    print("ğŸ“¦ Event Payload:");
    print(event);
    print("ğŸ”š === END SYSTEM READY ===");
}

// âœ… Demo completion
on learning.session.complete (event)
{
    print("\nğŸ† === LEARNING SESSION COMPLETE ===");
    print("ğŸ“Š Total Events Analyzed: " + event.eventCount);
    print("ğŸ¯ Agent: " + event.agent);
    print("ğŸ“¦ Final Event Payload:");
    print(event);
    print("ğŸ”š === END LEARNING SESSION ===");
    
    print("\nğŸ“š LEARNING SUMMARY:");
    print("âœ… Event system: ANALYZED");
    print("âœ… Payload structures: UNDERSTOOD");
    print("âœ… Audio events: TRACED");
    print("âœ… AI service events: MONITORED");
    print("ğŸ“ Learning complete!");
}

// ğŸš€ Start the learning demo
print("\nğŸ¬ === INITIALIZING LEARNING DEMO ===");
var learningAgent = new LearningAgent();
print("âœ… Learning agent created: " + learningAgent.name);
print("ğŸ“Š Event count: " + learningAgent.eventCount);

print("\nğŸ“ === STARTING LEARNING SESSION ===");
learningAgent.startLearning();

print("\nğŸ’¡ === LEARNING OBJECTIVES ===");
print("ğŸ” Analyze all event payloads");
print("ğŸ“¦ Understand data structures");
print("ğŸµ Trace audio playback events");
print("ğŸ§  Monitor AI service interactions");
print("âš¡ Learn event flow patterns");
print("ğŸ¯ Debug audio playback issue");

// Emit a final learning completion event after some processing
emit learning.session.complete { 
    agent: learningAgent.name,
    eventCount: learningAgent.eventCount,
    objectives: [
        "Event Analysis",
        "Payload Understanding", 
        "Audio Debugging",
        "System Learning"
    ]
};
